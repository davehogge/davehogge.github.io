{% assign categories = '' %}
{% for post in site.posts %}
    {% if post.url == page.url %}
        {% assign categories = post.categories %}
    {% endif %}
{% endfor %}

{% assign total = '0' %}
{% assign item = '0' %}
{% for post in site.posts reversed %}
    {% if post.categories == page.categories %}
		{% if post.url == page.url %}
            {% capture item %}{{ total }}{% endcapture %}
		{% endif %}
	{% endif %}
{% endfor %}

<div class="related">
    <h2>Related Posts</h2>
    <ul class="related-posts">
    {% assign total = '0' %}
    {% for post in site.posts reversed %}
        {% if post.categories == page.categories %}
            <li>
            {% if page.url != post.url %}
                <h3>
                    <a href="{{ post.url }}">{{ post.title }} <small>{{ post.date | date_to_string }}</small></a>
                </h3>
            {% endif %}
            </li>
        {% endif %}
	{% endfor %}
	</ul>
</div>